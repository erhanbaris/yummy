<!DOCTYPE html>
<html>

<head>
    <title>Page Title</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.16.14/dist/css/uikit.min.css" />

    <!-- UIkit JS -->
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.14/dist/js/uikit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.16.14/dist/js/uikit-icons.min.js"></script>
</head>



<body>
    <div id="app">
        <div class="uk-align-center uk-card uk-card-default uk-card-body uk-width-1-2@m">
            <div uk-grid>
                <div class="uk-width-1-3@m">
                    <span class="uk-card-title uk-align-center">
                        Tic-Tac-Toe Rooms
                    </span>
                </div>
                <div class="uk-width-expand@m uk-align-right">
                    <ul class="uk-iconnav">
                        <li><a href="#" uk-icon="icon: plus" @click="new_room()"> New Room </a></li>
                        <li><a href="#" uk-icon="icon: refresh" @click="room_list()"> Refresh </a></li>
                    </ul>
                </div>
            </div>

            <template v-if="room_id == ''">
                <template v-if="rooms.length > 0" v-for="item in rooms" :key="item.id">
                    <div uk-grid>
                        <div class="uk-width-1-3@m">
                            <span class="uk-label uk-label-success uk-button-small">Waiting player</span>
                        </div>
                        <div class="uk-width-expand@m">
                            {{ item.name }}
                        </div>
                        <div class="uk-width-auto@m">
                            <button class="uk-button uk-button-secondary uk-button-small" @click="jon_to_room(item.id)">
                                <span uk-icon="play"></span>
                                Join
                            </button>
                        </div>
                    </div>
                    <hr class="uk-divider-icon">
                </template>

                <div v-else class="uk-alert-primary" uk-alert>
                    <p>Opss, there is no room to join, but you can create new one.</p>
                </div>
            </template>

            <template v-else>
                <div class="uk-column-1-3" style="width: 400px;">

                    <div class="uk-margin" v-for="(item, index) in board">
                        <a href="#" class="uk-icon-link" @click="play(index, 'X')">
                            <div class="uk-card uk-card-default uk-card-body" v-bind:class="{ 'uk-background-primary uk-light': item != '&nbsp;' }"> 
                                <span v-html="item"></span>
                            </div>
                        </a>
                    </div>
                </div>
            </template>
        </div>

    </div>
    <script>
        const URL = "ws://127.0.0.1:9090/v1/socket?x-yummy-api=YummyYummy";

        var app = new Vue({
            el: '#app',
            data: {
                connection: "",
                custom_id: "",
                room_id: "",
                rooms: [],
                board: ["&nbsp;", "&nbsp;", "&nbsp;",
                        "&nbsp;", "&nbsp;", "&nbsp;",
                        "&nbsp;", "&nbsp;", "&nbsp;"
                ]
            },

            methods: {
                new_room() {
                    this.connection.send(JSON.stringify({
                        "type": "CreateRoom",
                        "name": this.custom_id + "'s room"
                    }));
                },
                room_list() {
                    this.connection.send(JSON.stringify({
                        "type": "RoomList",
                        //"members": [4, 0, 6]
                    }));
                },
                jon_to_room(room_id) {
                    this.connection.send(JSON.stringify({
                        "type": "JoinToRoom",
                        "room_id": room_id
                    }));
                },
                get_point(index) {
                    return this.board[index];
                },
                slot_used(index) {
                    return this.board[index] != "&nbsp;";
                },
                play(index, type) {
                    this.connection.send(JSON.stringify({
                        "type": "MessageToRoom",
                        "room_id": this.room_id,
                        "message": "play;" + index + ";" + type
                    }));
                    Vue.set(this.board, index, type)
                }
            },

            created() {
                let connection = new WebSocket(URL);
                connection.onopen = () => {
                    this.custom_id = "USER-" + window.crypto.getRandomValues(new Uint32Array(1))[0].toString(8);
                    connection.send(JSON.stringify({
                        "type": "AuthCustomId",
                        "id": this.custom_id
                    }));
                };

                connection.onmessage = (event) => {
                    const message = JSON.parse(event.data);

                    if (message.status) {
                        switch (message.type) {
                            case "Authenticated": {
                                // Update user
                                connection.send(JSON.stringify({
                                    "type": "UpdateUser",
                                    "name": this.custom_id,
                                }));

                                // Get room list
                                this.room_list();
                                break;
                            }

                            case "RoomList": {
                                console.log(this.rooms);
                                app.rooms = message.rooms;
                                break;
                            }

                            case "Joined":
                            case "RoomCreated": {
                                this.room_id = message.room_id;
                                break;
                            }
                        }
                    }
                    console.log(message)
                };

                this.connection = connection;
            },
        });

    </script>
</body>

</html>